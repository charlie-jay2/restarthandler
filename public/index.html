<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    button {
      padding: 5px 10px;
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
    }
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    .popup {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .popup h3 {
      text-align: center;
      margin-bottom: 20px;
    }
    .popup input, .popup textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .popup button {
      width: 100%;
    }
  </style>
</head>
<body>

<h1>Report Submission</h1>

<!-- Reports Table -->
<table id="reportsTable">
  <thead>
    <tr>
      <th>Reference</th>
      <th>Status</th>
      <th>Description</th>
      <th>Proof</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Button to Open Report Form -->
<button onclick="openReportPopup()">Submit Report</button>

<!-- Report Form Popup -->
<div id="popupOverlay" class="popup-overlay">
  <div class="popup">
    <h3>Submit Report</h3>
    <input type="text" id="reporterIdInput" placeholder="Enter Reporter ID" />
    <input type="text" id="reportedIdInput" placeholder="Enter Reported User ID" />
    <textarea id="descriptionInput" placeholder="Enter Description" rows="4"></textarea>
    <textarea id="proofInput" placeholder="Enter Proof (optional)" rows="2"></textarea>
    <button id="submitReportBtn">Submit Report</button>
    <button id="closePopupBtn">Close</button>
  </div>
</div>

<script>
  const popupOverlay = document.getElementById('popupOverlay');
  const submitReportBtn = document.getElementById('submitReportBtn');
  const reportListTable = document.getElementById('reportsTable').getElementsByTagName('tbody')[0];

  function openReportPopup() {
    popupOverlay.style.display = 'flex';
  }

  document.getElementById('closePopupBtn').addEventListener('click', () => {
    popupOverlay.style.display = 'none';
  });

  document.getElementById('submitReportBtn').addEventListener('click', async () => {
    const reporterId = document.getElementById('reporterIdInput').value.trim();
    const reportedId = document.getElementById('reportedIdInput').value.trim();
    const description = document.getElementById('descriptionInput').value.trim();
    const proof = document.getElementById('proofInput').value.trim();

    if (!reporterId || !reportedId || !description) {
      return alert('Please fill in all required fields');
    }

    // Send the report to the backend
    const res = await fetch('/reports', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reporterId, reportedId, description, proof })
    });

    const data = await res.json();
    if (data.reference) {
      alert('Report submitted successfully');
      loadReports(); // Reload the report list
    } else {
      alert('Failed to submit report');
    }

    // Close the popup
    popupOverlay.style.display = 'none';
  });

  async function loadReports() {
    reportListTable.innerHTML = '';
    const r = await fetch('/get-reports');
    const reports = await r.json();
    console.log('Fetched Reports:', reports);
    if (Array.isArray(reports)) {
      reports.forEach(rp => {
        const ref = rp.reference;
        const out = (rp.history && rp.history.length > 0) ? rp.history[rp.history.length - 1].note : 'Not Set';
        const proof = rp.proof || 'No proof provided'; // Show proof or default message
        const row = reportListTable.insertRow();
        row.innerHTML = `
          <td>${ref}</td>
          <td>${rp.status}</td>
          <td>${out}</td>
          <td>${proof}</td>
          <td><button onclick="editReport('${ref}')">Edit</button></td>
        `;
      });
    }
  }

  loadReports(); // Load the reports initially
</script>
</body>
</html>
